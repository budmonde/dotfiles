# Meta key
unbind-key C-b
set-option -g prefix C-a
bind-key C-a send-prefix

# Navigation
set-option -g mode-keys vi

# Vim-tmux navigation using if -F (format conditional, no subshell)
# Pattern matches: vim, nvim, vi, view, vimdiff, nvim-qt, etc.
bind-key -n M-h if -F '#{m/ri:^(view|n?vim?)(diff)?$,#{pane_current_command}}' 'send-keys M-h' 'select-pane -L'
bind-key -n M-j if -F '#{m/ri:^(view|n?vim?)(diff)?$,#{pane_current_command}}' 'send-keys M-j' 'select-pane -D'
bind-key -n M-k if -F '#{m/ri:^(view|n?vim?)(diff)?$,#{pane_current_command}}' 'send-keys M-k' 'select-pane -U'
bind-key -n M-l if -F '#{m/ri:^(view|n?vim?)(diff)?$,#{pane_current_command}}' 'send-keys M-l' 'select-pane -R'
bind-key -n 'M-\' if -F '#{m/ri:^(view|n?vim?)(diff)?$,#{pane_current_command}}' 'send-keys M-\\' 'select-pane -l'
bind-key -n M-H select-window -t :-
bind-key -n M-L select-window -t :+

# Copy paste
bind-key -T copy-mode-vi "v" send -X begin-selection
bind-key -T copy-mode-vi "V" send -X rectangle-toggle
bind-key -T copy-mode-vi "y" send -X copy-selection-and-cancel

# Window naming - disable auto-rename when explicitly naming a window
bind-key , command-prompt -I "#W" "rename-window '%%' ; set-window-option automatic-rename off"
# Clear name and re-enable auto-rename
bind-key . set-window-option automatic-rename on \; display-message "automatic-rename enabled"

# New window/panes
bind-key c new-window -c "#{pane_current_path}"
unbind-key '"'
unbind-key %
bind-key v split-window -h -c "#{pane_current_path}"
bind-key h split-window -v -c "#{pane_current_path}"

# Toggle keyboard input for panes
bind-key < select-pane -d \; display-message "input disabled"
bind-key > select-pane -e \; display-message "input enabled"

# Swap window position
bind-key -r '{' swap-window -t -1 \; select-window -t -1
bind-key -r '}' swap-window -t +1 \; select-window -t +1

# Enable mouse control
set-option -g mouse on

# 1-index window numbers (match keyboard shortcut)
set-option -g base-index 1
set-window-option -g pane-base-index 1

# renumber windows
set-option -g renumber-windows on

# monitor windows activity
set-window-option -g monitor-activity on

# don't wait for escape sequences
set-option -sg escape-time 0

# display pane numbers for longer
set-option -g display-panes-time 2000

# increase scrollback length
set-option -g history-limit 65536

# Reload .tmux.conf
bind r source-file ~/.tmux.conf \; display-message "configuration reloaded"

# Theming
# Use tmux-256color if available (supports italics), fallback to screen-256color
if-shell 'infocmp tmux-256color >/dev/null 2>&1' \
    'set-option -g default-terminal "tmux-256color"' \
    'set-option -g default-terminal "screen-256color"'
set-option -sa terminal-overrides ',xterm-256color:Tc'

set-option -g status-style bg=colour235,fg=colour136
set-window-option -g window-status-style fg=colour244
set-window-option -g window-status-current-style fg=colour166
set-window-option -g window-status-activity-style fg=colour61
set-window-option -g window-status-bell-style fg=colour61
set-option -g pane-border-style fg=colour235
set-option -g pane-active-border-style fg=colour240
set-option -g message-style bg=colour235,fg=colour166

set-option -g display-panes-active-colour colour166
set-option -g display-panes-colour colour33

set-option -g clock-mode-colour colour64

# WSL Only settings
if-shell '[ -f /proc/sys/fs/binfmt_misc/WSLInterop ]' {
    bind -n M-w run -b "tmux show-buffer | clip.exe"
}

# Plugins (managed by TPM)
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# Resurrect settings
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'

# Continuum settings
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'

# Initialize TPM (keep this line at the very bottom)
run '~/.tmux/plugins/tpm/tpm'
