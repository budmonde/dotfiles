#!/usr/bin/env bash
# Cross-platform notification script
# Usage: notify [title] [message]

set -e

title="${1:-Notification}"
message="${2:-Task finished}"

# Detect platform and send notification
if [[ -n "$WSL_DISTRO_NAME" ]]; then
    # WSL - use Windows Toast notifications
    powershell.exe -NoLogo -NonInteractive -WindowStyle Hidden -Command \
    "[Windows.UI.Notifications.ToastNotificationManager, Windows.UI.Notifications, ContentType = WindowsRuntime] > \$null;
    [Windows.Data.Xml.Dom.XmlDocument, Windows.Data.Xml.Dom.XmlDocument, ContentType = WindowsRuntime] > \$null;
    \$template = [Windows.UI.Notifications.ToastNotificationManager]::GetTemplateContent([Windows.UI.Notifications.ToastTemplateType]::ToastText02);
    \$textNodes = \$template.GetElementsByTagName('text');
    \$textNodes.Item(0).AppendChild(\$template.CreateTextNode('$title')) > \$null;
    \$textNodes.Item(1).AppendChild(\$template.CreateTextNode('$message')) > \$null;
    \$toast = [Windows.UI.Notifications.ToastNotification]::new(\$template);
    \$notifier = [Windows.UI.Notifications.ToastNotificationManager]::CreateToastNotifier('WSL');
    \$notifier.Show(\$toast);" \
    > /dev/null 2>&1

elif [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS - use osascript
    osascript -e "display notification \"$message\" with title \"$title\""

elif command -v notify-send &> /dev/null; then
    # Linux with libnotify
    notify-send "$title" "$message"

elif command -v kdialog &> /dev/null; then
    # KDE
    kdialog --passivepopup "$message" --title "$title" 5

elif command -v zenity &> /dev/null; then
    # GNOME/GTK
    zenity --notification --text="$title: $message"

else
    echo "Error: No notification system available" >&2
    echo "$title: $message" >&2
    exit 1
fi
